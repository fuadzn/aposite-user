<?php
$this->load->view('layout/header');
?>

<section class="content">
    <div class="row match-height">
    <div class="col-md-12">
				<?php echo $this->session->flashdata('success_msg'); ?>
    </div>
    <!-- <?php echo form_open('nisn/update_siswa');?> -->
        <!-- Modal Edit Obat -->
        <form id="form_sso">
        
        <div class="modal fade" id="invite_user" role="dialog" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-success">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Invite User</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group row">
                            <div class="col-sm-1"></div>
                            <p class="col-sm-3 form-control-label">SSO User</p><br>
                            <div class="col-sm-6">
                                <input type="search" class="auto_search_user_sso form-control" name="user_sso" id="user_sso">
                                <input type="text" class="form-control" name="d_name" id="d_name" hidden>
                                <input type="text" class="form-control" name="username" id="username" hidden>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-1"></div>
                            <p class="col-sm-3 form-control-label">Role</p>
                            <div class="col-sm-6">
                                <select id="pilih_admin" class="custom-select form-control select2" style="width: 100%" name="pilih_admin" onchange="pilihAdmin(this.value)" required>
                              <option value="0">-- Pilih Role --</option>
                              <option value="2">Admin</option>
                              <option value="11">Admin Provinsi</option>
                              <option value="10">Admin Kota / Kabupaten</option>
                         </select>
                            </div>
                        </div>
                        <div class="form-group row" id="fprovinsi">
                            <div class="col-sm-1"></div>
                            <p class="col-sm-3 form-control-label">Provinsi</p>
                            <div class="col-sm-6">
                            <select id="nama_provinsi" name="nama_provinsi" class="form-control nama_provinsi select2" onchange="pilihProvinsi(this.value)" style="width:221px">
                                   <option value="">-- Pilih Provinsi --</option>
                                        <?php 
                                        foreach($provinsi as $row){
                                             echo '<option value="'.$row->id_provinsi.'">'.$row->nm_provinsi.'</option>';
                                        }
                                        ?>
                              </select>
                            </div>
                        </div>
                        <div class="form-group row" id="fkota">
                            <div class="col-sm-1"></div>
                            <p class="col-sm-3 form-control-label">Kota/Kabupaten</p>
                            <div class="col-sm-6">
                            <input type="hidden" class="form-control" id="nama_kota_v" >
                              <select id="nama_kota" name="nama_kota" class="form-control nama_kota select2" style="width:221px"></select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button class="btn btn-primary" type="button" id="btn-submit" onclick="insert_sso()">Invite</button>
                    </div>
                </div>
            </div>
        </div>
        </form>
        <!-- <?php echo form_close();?> -->
        <div class="col-12">
            <div class="card">
                <div class="card-content">
                    <button class="btn btn-primary mt-2" type="button" data-toggle="modal" data-target="#invite_user" style="margin-left:1200px;" value="Invite User">
                        <i class="fa fa-plus"></i> Invite User</button>
                    <div class="card-body table-responsive">
                        <table id="table_nisn" class="display table table-hover table-bordered table-striped" cellspacing="0" style="width:100%" style="display:block;overflow:auto;">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Email</th>
                                    <th>Username</th>
                                    <th>Display Name</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Last Loggin</th>
                                </tr>
                            </thead>                       
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<?php
$this->load->view("layout/footer");
?>
<script>

    var tabel_detail;
    $(document).ready(function() {
   $('.auto_search_user_sso').autocomplete({
               serviceUrl: '<?php echo site_url(); ?>sso/get_autocomplete',
               onSelect: function (suggestion) {
                $('#user_sso').val('' + suggestion.value);
                $("#d_name").val(suggestion.display);
                $('#username').val(suggestion.user);
               }
   });
        $('.select2').select2();

        $('#aksi').attr('hidden', true);
        tabel_detail = $('#table_nisn').DataTable({
            aoColumnDefs: [
                { bSortable: false, aTargets: [ 0 ] }
            ],
          ajax: {
            "url": '<?php echo site_url('sso/show_data_siswa')?>',
            "type": 'POST',
            "data": function ( d ) {
            },
              },
              columns: [
                { data: "no" },
                { data: "email" },
                { data: "username" },
                { data: "display_name" },
                { data: "role" },
                { data: "status" },
                { data: "last_login" }
              ]
        });
        tabel_detail.on( 'order.table_nisn search.table_nisn', function () {
        tabel_detail.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
            cell.innerHTML = i+1;
        } );
    } ).draw();
    
    $('#fprovinsi').hide();
    $('#fkota').hide();

        $('#sso_user').autocomplete({
        source: function (request, response) {
            $.getJSON("sso.teratai.id/kc-admin/users" + request.term, function (data) {
                response($.map(data.email, function (value, key) {
                    return {
                        label: value,
                        value: key
                    };
                }));
            });
        },
        minLength: 2,
        delay: 100
        });
    });

    function insert_sso() {
        if ($('#user_sso').val() == "") {
            swal.fire("Maaf", "Harap Isi User Email.", "error")
        } else if ($('#pilih_admin').val() == "0") {
            swal.fire("Maaf", "Harap Isi Role.", "error")
        } else {
            document.getElementById("btn-submit").innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';
            $.ajax({
                type: "POST",
                url: "<?php echo site_url('sso/insert_sso'); ?>",
                dataType: "JSON",
                data: $('#form_sso').serialize(),
                success: function(result) {
                         if (result.success) {
                              document.getElementById("btn-submit").innerHTML = 'Buat Email';
                              $('#invite_user').modal('hide');
                              $('.modal-backdrop').remove();
                              swal.fire({
                                   title: 'Berhasil',
                                   type: 'success',
                                   text: 'Data berhasil disimpan.',
                                   showCancelButton: false,
                                   confirmButtonText: 'Ok',
                                   confirmButtonClass: 'btn btn-primary',
                                   buttonsStyling: false,
                                   customClass: 'swal-wide',
                              }).then(function(result) {
                                tabel_detail.ajax.reload();
                              });
                    } else {
                        if (result.msg !== '') {
                            document.getElementById("btn-submit").innerHTML = 'Simpan';
                            Swal.fire({
                                type: 'warning',
                                title: 'Gagal!',
                                text: 'Email sudah terdaftar!'
                            }).then(function(result) {
                                window.location.reload();
                              });
                        }
                    }
                },
                error: function(event, textStatus, errorThrown) {
                    document.getElementById("btn-submit").innerHTML = 'Simpan';
                    $('#invite_user').modal('hide');
                    $('.modal-backdrop').remove();
                    swal.fire("Error", "Gagal menyimpan data.", "error");
                    console.log('Error Message: ' + textStatus + ' , HTTP Error: ' + errorThrown);
                }
            });
        }
    }


    function changePassword(id, nisn, email){
        document.getElementById("reset_pass_"+nisn).innerHTML = '<i class="fa fa-spinner fa-spin"></i> Loading...';
        $.ajax({
            dataType: "JSON",
            type: 'POST',
            url: "<?php echo base_url('sso/changePass'); ?>",
            data: {'email' : email},
            success: function(response) {
                if (response.success) {
                    document.getElementById("reset_pass_"+nisn).innerHTML = '<i class="fa fa-lock"></i> Reset Password';
                    tabel_detail.ajax.reload();
                    Swal.fire("Sukses",response.msg, "success");
                } else {
                    document.getElementById("reset_pass_"+nisn).innerHTML = '<i class="fa fa-lock"></i> Reset Password';
                    Swal.fire("Error",response.msg, "error");
                }
            }
        });
        $.ajax({
            dataType: "JSON",
            type: 'POST',
            url: "<?php echo base_url('sso/send_mail'); ?>",
            data: {'id' : id},
            success: function(response) {
                if (response.success) {
                } else {
                }
            }
        });
    }

    function edit_siswa(id) {
            $.ajax({
                type:'POST',
                dataType: 'json',
                url:"<?php echo base_url('sso/edit_siswa')?>",
                data: {
                    id: id
                },
                success: function(data){
                    $('#edit_nisn').val(data[0].nisn);
                    $('#edit_npsn').val(data[0].npsn);
                    $('#edit_sekolah').val(data[0].nm_sekolah);
                    $('#edit_kelas').val(data[0].kelas);
                    $('#edit_nama').val(data[0].nama);
                },
                error: function(){
                    alert("error");
                }
            });
        }

        function hapus_siswa(id) {
        Swal.fire({
          title: 'Hapus Data Siswa?',
          text: 'Benar Akan Menghapus Data ini?',
          type: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Ya',
          confirmButtonClass: 'btn btn-primary',
          cancelButtonText: 'Tidak',
          cancelButtonClass: 'btn btn-danger ml-1',
          buttonsStyling: false,
        }).then(function (result) {
            if (result.value) {
            $.ajax({
                    type:'post',
                    dataType: 'json',
                    url:"<?php echo base_url('sso/hapus_siswa')?>",
                    data: {
                        id: id
                    },
                    success: function(data){
                        if(data.status=='success'){
                            Swal.fire({
                                title: 'Selesai',
                                text: 'Data Sudah Dihapus',
                                type: 'success',
                                showCancelButton: false,
                                confirmButtonText: 'Ok',
                                confirmButtonClass: 'btn btn-primary',
                                buttonsStyling: false,
                            }).then(function (result) {
                                window.location.reload();
                            });
                        }else {
                            Swal.fire(data.status, "Terjadi Kesalahan !", "error");
                        }
                    },
                    error: function(data){

                    }
                });
            }
            });
        }

        var val_admin = $('#pilih_admin').val();
     pilihAdmin(val_admin);
     function pilihAdmin(val_admin) {
		if (val_admin == '2') {
			$('#fprovinsi').hide();
			$('#fkota').hide();
		} else if (val_admin == '11'){
			$('#fprovinsi').show();
			$('#fkota').hide();
		} else{
			$('#fprovinsi').show();
			$('#fkota').show();
		}
     }

        function pilihProvinsi(){
		$.ajax({
	        type: "POST",
	        dataType: "JSON",
	        data: {
	        	"nama_provinsi" : $('#nama_provinsi').val()
	        },
	        url: "<?php echo site_url('sso/get_data_kota')?>",
	        success: function(response){
	            if(response.success){
	                $("#nama_kota").html(response.data);
		            $("#nama_kota").attr('disabled', false);
	                if($('#nama_kota_v').val()!="")
						$('#nama_kota').val($('#nama_kota_v').val()).change();
	           	}else{
	                $("#nama_kota").html(response.data);
	            	$("#nama_kota").attr('disabled', true);
	           	}
	        }
	    });
     }

    // function send_email(id) {
    //     $.ajax({
    //         type: 'POST',
    //         dataType: 'json',
    //         url: "<?php echo base_url('sso/get_data_email') ?>",
    //         data: {
    //             id: id
    //         },
    //         success: function(data) {
    //             $('#id_siswa').val(data[0].id);
    //             $('#email').val(data[0].email_alter);
    //         },
    //         error: function() {
    //             alert("error");
    //         }
    //     });
    // }
</script>